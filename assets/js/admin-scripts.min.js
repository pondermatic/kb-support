function kbs_load_ticket_replies(a,b){jQuery("#kbs-replies-loader").html('<img src="'+kbs_vars.ajax_loader+'" />'),jQuery.post(ajaxurl,{action:"kbs_display_ticket_replies",kbs_ticket_id:a,kbs_reply_id:b},function(a){jQuery(".kbs_replies_accordion").prepend(a),jQuery(".kbs_replies_accordion").accordion("refresh"),jQuery("#kbs-replies-loader").html("")})}function kbs_load_ticket_notes(a,b){jQuery("#kbs-notes-loader").html('<img src="'+kbs_vars.ajax_loader+'" />'),jQuery.post(ajaxurl,{action:"kbs_display_ticket_notes",kbs_ticket_id:a,kbs_note_id:b},function(a){jQuery(".kbs_notes_accordion").prepend(a),jQuery(".kbs_notes_accordion").accordion("refresh"),jQuery("#kbs-notes-loader").html("")})}var kbs_vars;jQuery(document).ready(function(a){var b=a(".kbs_datepicker");if(b.length>0){var c="mm/dd/yy";b.datepicker({dateFormat:c})}if(a(".kbs_select_chosen").chosen({inherit_select_classes:!0}),kbs_vars.post_type&&"kbs_ticket"===kbs_vars.post_type){var d={header:"ui-icon-circle-arrow-e",activeHeader:"ui-icon-circle-arrow-s"};a(".kbs_accordion, .kbs_notes_accordion, .kbs_replies_accordion").accordion({active:!1,collapsible:!0,icons:d})}var e={init:function(){this.general()},general:function(){var b=a(".kbs-color-picker");if(b.length&&b.wpColorPicker(),"undefined"==typeof wp||"1"!==kbs_vars.new_media_ui){var c=a(".kbs_settings_upload_button");c.length>0&&(window.formfield="",a(document.body).on("click",c,function(b){b.preventDefault(),window.formfield=a(this).parent().prev(),window.tbframe_interval=setInterval(function(){jQuery("#TB_iframeContent").contents().find(".savesend .button").val(kbs_vars.use_this_file).end().find("#insert-gallery, .wp-post-thumbnail").hide()},2e3),tb_show(kbs_vars.add_new_ticket,"media-upload.php?TB_iframe=true")}),window.kbs_send_to_editor=window.send_to_editor,window.send_to_editor=function(b){window.formfield?(imgurl=a("a","<div>"+b+"</div>").attr("href"),window.formfield.val(imgurl),window.clearInterval(window.tbframe_interval),tb_remove()):window.kbs_send_to_editor(b),window.send_to_editor=window.kbs_send_to_editor,window.formfield="",window.imagefield=!1})}else{var d;window.formfield="",a(document.body).on("click",".kbs_settings_upload_button",function(b){b.preventDefault();var c=a(this);return window.formfield=a(this).parent().prev(),d?void d.open():(d=wp.media.frames.file_frame=wp.media({frame:"post",state:"insert",title:c.data("uploader_title"),button:{text:c.data("uploader_button_text")},multiple:!1}),d.on("menu:render:default",function(a){var b={};a.unset("library-separator"),a.unset("gallery"),a.unset("featured-image"),a.unset("embed"),a.set(b)}),d.on("insert",function(){var a=d.state().get("selection");a.each(function(a){a=a.toJSON(),window.formfield.val(a.url)})}),void d.open())})}}};e.init();var f={init:function(){this.reply(),this.notes()},reply:function(){a(document.body).on("click","#kbs-reply-close, #kbs-reply-update",function(b){b.preventDefault();var c=kbs_vars.post_id,d="",e="undefined"!=typeof tinyMCE&&tinyMCE.activeEditor&&!tinyMCE.activeEditor.isHidden();if(e&&tinyMCE.triggerSave(),d=a("#kbs_ticket_reply").val(),0===d.length)return window.alert(kbs_vars.no_ticket_reply_content),!1;if("kbs-reply-close"===b.target.id){var f=confirm(kbs_vars.ticket_confirm_close);if(f===!1)return}var g={ticket_id:c,response:d,close_ticket:"kbs-reply-close"===b.target.id?1:0,action:"kbs_insert_ticket_reply"};a.ajax({type:"POST",dataType:"json",data:g,url:ajaxurl,beforeSend:function(){a(".kbs-reply").hide(),a("#kbs-new-reply-loader").html('<img src="'+kbs_vars.ajax_loader+'" />')},success:function(b){return b.reply_id?(kbs_load_ticket_replies(c,b.reply_id),window.location.href=kbs_vars.admin_url+"?kbs-action=ticket_reply_added&ticket_id="+c,!0):(window.alert(kbs_vars.reply_not_added),a("#kbs-new-reply-loader").html(""),void a(".kbs-reply").show())}}).fail(function(a){window.console&&window.console.log&&console.log(a)})})},notes:function(){a(document.body).on("click","#kbs-add-note",function(){var b=a("#kbs_new_note").val(),c=kbs_vars.post_id;if(b.length<1)return void window.alert(kbs_vars.no_note_content);var d={ticket_id:c,note_content:b,action:"kbs_insert_ticket_note"};a.ajax({type:"POST",dataType:"json",data:d,url:ajaxurl,beforeSend:function(){a("#kbs-add-note").hide(),a("#kbs-new-note-loader").html('<img src="'+kbs_vars.ajax_loader+'" />')},success:function(b){b.note_id?(kbs_load_ticket_notes(c,b.note_id),a("#kbs_new_note").val("")):window.alert(kbs_vars.note_not_added),a("#kbs-new-note-loader").html(""),a("#kbs-add-note").show()}}).fail(function(a){window.console&&window.console.log&&console.log(a)})}),"1"===kbs_vars.editing_ticket&&setTimeout(function(){kbs_load_ticket_replies(kbs_vars.post_id,0),kbs_load_ticket_notes(kbs_vars.post_id,0)},200)}};f.init();var g={init:function(){this.forms(),this.move()},forms:function(){var b=function(b){"text"===b||"date_field"===b||"email"===b||"number"===b||"select"===b||"textarea"===b||"url"===b?(a("#kbs_meta_field_placeholder_wrap").show(),a("#kbs_meta_field_hide_label_wrap").show()):(a("#kbs_meta_field_placeholder_wrap").hide(),a("#kbs_meta_field_hide_label_wrap").hide()),"select"===b||"checkbox_list"===b||"radio"===b?a("#kbs_meta_field_select_options_wrap").show():a("#kbs_meta_field_select_options_wrap").hide(),"select"===b?a("#kbs_meta_field_select_multiple_wrap").show():a("#kbs_meta_field_select_multiple_wrap").hide(),"select"===b||"ticket_category_dropdown"===b?a("#kbs_meta_field_select_searchable_wrap").show():a("#kbs_meta_field_select_searchable_wrap").hide(),"checkbox"===b?a("#kbs_meta_field_option_selected_wrap").show():a("#kbs_meta_field_option_selected_wrap").hide(),"checkbox"===b||"file_upload"===b?a("#kbs_meta_field_required_wrap").hide():a("#kbs_meta_field_required_wrap").show(),"recaptcha"===b?(a("#kbs_meta_field_required_wrap").hide(),a("#kbs_meta_field_label_class_wrap").hide(),a("#kbs_meta_field_input_class_wrap").hide()):(a("#kbs_meta_field_required_wrap").show(),a("#kbs_meta_field_label_class_wrap").show(),a("#kbs_meta_field_input_class_wrap").show()),"text"===b||"email"===b||"url"===b||"textarea"===b||"rich_editor"===b?a("#kbs_meta_field_mapping_wrap").show():a("#kbs_meta_field_mapping_wrap").hide(),"post_title"===a("#kbs_field_mapping").val()?a("#kbs_meta_field_kb_search_wrap").show():a("#kbs_meta_field_kb_search_wrap").hide()};kbs_vars.editing_field_type&&b(kbs_vars.editing_field_type);var c=a(".kbs_field_type");a(document.body).on("change",c,function(){b(c.val())}),a(document.body).on("change",a("#kbs_field_mapping"),function(){"post_title"===a("#kbs_field_mapping").val()?a("#kbs_meta_field_kb_search_wrap").show():a("#kbs_meta_field_kb_search_wrap").hide()}),a(document.body).on("click","#kbs-add-form-field",function(b){if(b.preventDefault(),a("#kbs_field_label").val().length<1)return window.alert(kbs_vars.field_label_missing),!1;if("-1"===a("#kbs_field_type").val())return window.alert(kbs_vars.field_type_missing),!1;var c=a("#form_return_url").val(),d={form_id:kbs_vars.post_id,form_data:a("#post").serialize(),label:a("#kbs_field_label").val(),type:a("#kbs_field_type").val(),mapping:a("#kbs_field_mapping").val(),kb_search:a("#kbs_field_kb_search").is(":checked")?a("#kbs_field_kb_search").val():0,required:a("#kbs_field_required").is(":checked")?a("#kbs_field_required").val():0,label_class:a("#kbs_field_label_class").val(),input_class:a("#kbs_field_input_class").val(),select_options:a("textarea#kbs_field_select_options").val(),select_multiple:a("#kbs_field_select_multiple").is(":checked")?a("#kbs_field_select_multiple").val():0,selected:a("#kbs_field_option_selected").is(":checked")?a("#kbs_field_option_selected").val():0,chosen:a("#kbs_field_select_chosen").is(":checked")?a("#kbs_field_select_chosen").val():0,description:a("#kbs_field_description").val(),description_pos:a("input[name=kbs_field_description_pos]").filter(":checked").val(),placeholder:a("#kbs_field_placeholder").val(),hide_label:a("#kbs_field_hide_label").is(":checked")?a("#kbs_field_hide_label").val():0,action:"kbs_add_form_field"};a.ajax({type:"POST",dataType:"json",data:d,url:ajaxurl,beforeSend:function(){a("#kbs-field-add").addClass("kbs-hidden"),a("#kbs-loading").removeClass("kbs-hidden")},success:function(a){return window.location.href=c+"&kbs-message="+a.message,!0}}).fail(function(b){a("#kbs-field-add").removeClass("kbs-hidden"),a("#kbs-loading").addClass("kbs-hidden"),window.console&&window.console.log&&console.log(b)})}),a(document.body).on("click","#kbs-save-form-field",function(b){if(b.preventDefault(),a("#kbs_field_label").val().length<1)return window.alert(kbs_vars.field_label_missing),!1;if("-1"===a("#kbs_field_type").val())return window.alert(kbs_vars.field_type_missing),!1;var c=a("#form_return_url").val(),d={form_id:kbs_vars.post_id,form_data:a("#post").serialize(),field_id:a("#kbs_edit_field").val(),label:a("#kbs_field_label").val(),type:a("#kbs_field_type").val(),mapping:a("#kbs_field_mapping").val(),kb_search:a("#kbs_field_kb_search").is(":checked")?a("#kbs_field_kb_search").val():0,required:a("#kbs_field_required").is(":checked")?a("#kbs_field_required").val():0,label_class:a("#kbs_field_label_class").val(),input_class:a("#kbs_field_input_class").val(),select_options:a("textarea#kbs_field_select_options").val(),select_multiple:a("#kbs_field_select_multiple").is(":checked")?a("#kbs_field_select_multiple").val():0,selected:a("#kbs_field_option_selected").is(":checked")?a("#kbs_field_option_selected").val():0,chosen:a("#kbs_field_select_chosen").is(":checked")?a("#kbs_field_select_chosen").val():0,placeholder:a("#kbs_field_placeholder").val(),description:a("#kbs_field_description").val(),description_pos:a("input[name=kbs_field_description_pos]").filter(":checked").val(),hide_label:a("#kbs_field_hide_label").is(":checked")?a("#kbs_field_hide_label").val():0,action:"kbs_save_form_field"};a.ajax({type:"POST",dataType:"json",data:d,url:ajaxurl,beforeSend:function(){a("#kbs-field-save").addClass("kbs-hidden"),a("#kbs-loading").removeClass("kbs-hidden")},success:function(a){return window.location.href=c+"&kbs-message="+a.message,!0}}).fail(function(b){a("#kbs-field-save").removeClass("kbs-hidden"),a("#kbs-loading").addClass("kbs-hidden"),window.console&&window.console.log&&console.log(b)})})},move:function(){a(".kbs_sortable_table tbody").sortable({handle:".kbs_draghandle",items:".kbs_sortable_row",opacity:.6,cursor:"move",axis:"y",update:function(){var b=a(this).sortable("serialize")+"&action=kbs_order_form_fields";a.post(ajaxurl,b,function(){})}})}};g.init();var h={vars:{customer_wrap_editable:a(".kbs-customer-wrapper .editable"),customer_wrap_edit_item:a(".kbs-customer-wrapper .edit-item"),user_id:a('input[name="customerinfo[user_id]"]'),note:a("#customer-note")},init:function(){this.add_customer(),this.edit_customer(),this.cancel_edit(),this.add_email(),this.user_search(),this.remove_user(),this.add_note(),this.delete_checked()},add_customer:function(){a(document.body).on("click","#kbs-add-customer-save",function(b){b.preventDefault();var c=a(this),d=c.parent(),e=a("#customer-name").val(),f=a("#customer_company").val(),g=a("#customer-email").val(),h=a("add_customer_nonce").val(),i={action:"kbs_add_customer",customer_name:e,customer_company:f,customer_email:g,_wpnonce:h};a.ajax({type:"POST",dataType:"json",data:i,url:ajaxurl,beforeSend:function(){a(".notice-wrap").html(""),d.find(".spinner").css("visibility","visible"),c.attr("disabled",!0)},success:function(b){return b.error?(c.attr("disabled",!1),a(".notice-wrap").html('<div class="notice notice-error"><p>'+b.message+"</p></div>"),d.find(".spinner").css("visibility","hidden"),void 0):(window.location.href=b.redirect,!0)}}).fail(function(a){window.console&&window.console.log&&console.log(a)})})},edit_customer:function(){a(document.body).on("click","#edit-customer",function(a){a.preventDefault(),h.vars.customer_wrap_editable.hide(),h.vars.customer_wrap_edit_item.fadeIn().css("display","block")})},cancel_edit:function(){a(document.body).on("click","#kbs-edit-customer-cancel",function(b){b.preventDefault(),h.vars.customer_wrap_edit_item.hide(),h.vars.customer_wrap_editable.show(),a(".kbs_user_search_results").html("")})},add_email:function(){a(document.body).on("click","#add-customer-email",function(b){b.preventDefault();var c=a(this),d=c.parent();d.parent().find(".notice-wrap").remove(),d.find(".spinner").css("visibility","visible"),c.attr("disabled",!0);var e=d.find('input[name="customer-id"]').val(),f=d.find('input[name="additional-email"]').val(),g=d.find('input[name="make-additional-primary"]').is(":checked"),h=d.find('input[name="add_email_nonce"]').val(),i={kbs_action:"customer-add-email",customer_id:e,email:f,primary:g,_wpnonce:h};a.post(ajaxurl,i,function(a){!0===a.success?window.location.href=a.redirect:(c.attr("disabled",!1),d.after('<div class="notice-wrap"><div class="notice notice-error inline"><p>'+a.message+"</p></div></div>"),d.find(".spinner").css("visibility","hidden"))},"json")})},user_search:function(){a(document.body).on("click.kbsSelectUser",".kbs_user_search_results a",function(b){b.preventDefault();var c=a(this).data("userid");h.vars.user_id.val(c)})},remove_user:function(){a(document.body).on("click","#disconnect-customer",function(b){b.preventDefault();var c=a('input[name="customerinfo[id]"]').val(),d={kbs_action:"disconnect-userid",customer_id:c,_wpnonce:a("#edit-customer-info #_wpnonce").val()};a.post(ajaxurl,d,function(){window.location.href=window.location.href},"json")})},add_note:function(){a(document.body).on("click","#add-customer-note",function(b){b.preventDefault();var c={kbs_action:"add-customer-note",customer_id:a("#customer-id").val(),customer_note:h.vars.note.val(),add_customer_note_nonce:a("#add_customer_note_nonce").val()};if(c.customer_note)a.ajax({type:"POST",data:c,url:ajaxurl,success:function(b){a("#kbs-customer-notes").prepend(b),a(".kbs-no-customer-notes").hide(),h.vars.note.val("")}}).fail(function(a){window.console&&window.console.log&&console.log(a)});else{var d=h.vars.note.css("border-color");h.vars.note.css("border-color","red"),setTimeout(function(){h.vars.note.css("border-color",d)},500)}})},delete_checked:function(){a("#kbs-customer-delete-confirm").change(function(){var b=a("#kbs-delete-customer");a(this).prop("checked")?b.attr("disabled",!1):b.attr("disabled",!0)})}};h.init(),a(".kbs-ajax-user-search").keyup(function(){var b=a(this).val(),c="";a(this).data("exclude")&&(c=a(this).data("exclude")),a(".kbs-ajax").show();var d={action:"kbs_search_users",user_name:b,exclude:c};document.body.style.cursor="wait",a.ajax({type:"POST",data:d,dataType:"json",url:ajaxurl,success:function(b){a(".kbs-ajax").hide(),a(".kbs_user_search_results").removeClass("hidden"),a(".kbs_user_search_results span").html(""),a(b.results).appendTo(".kbs_user_search_results span"),document.body.style.cursor="default"}})}),a(document.body).on("click.kbsSelectUser",".kbs_user_search_results span a",function(b){b.preventDefault();var c=a(this).data("login");a(".kbs-ajax-user-search").val(c),a(".kbs_user_search_results").addClass("hidden"),a(".kbs_user_search_results span").html("")}),a(document.body).on("click.kbsCancelUserSearch",".kbs_user_search_results a.kbs-ajax-user-cancel",function(b){b.preventDefault(),a(".kbs-ajax-user-search").val(""),a(".kbs_user_search_results").addClass("hidden"),a(".kbs_user_search_results span").html("")}),a("#kbs_dashboard_tickets").length&&a.ajax({type:"GET",data:{action:"kbs_load_dashboard_widget"},url:ajaxurl,success:function(b){a("#kbs_dashboard_tickets .inside").html(b)}}),a(document).on("keydown",".customer-note-input",function(b){13===b.keyCode&&(b.metaKey||b.ctrlKey)&&a("#add-customer-note").click()})});