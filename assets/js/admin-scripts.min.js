var KBSShowNotice,kbs_vars;function kbs_load_ticket_replies(e,t,s){jQuery("#kbs-replies-loader").html('<img src="'+kbs_vars.ajax_loader+'" />'),jQuery.post(ajaxurl,{action:"kbs_display_ticket_replies",kbs_ticket_id:e,kbs_reply_id:t,kbs_page:s},function(e){jQuery(".kbs-historic-reply-option-fields").append(e),jQuery("#kbs-replies-loader").html("")})}function kbs_load_ticket_notes(e,t){jQuery("#kbs-notes-loader").html('<img src="'+kbs_vars.ajax_loader+'" />'),jQuery.post(ajaxurl,{action:"kbs_display_ticket_notes",kbs_ticket_id:e,kbs_note_id:t},function(e){jQuery(".kbs-notes-option-fields").prepend(e),jQuery("#kbs-notes-loader").html("")})}jQuery(document).ready(function(n){var e=n(".kbs_datepicker");0<e.length&&e.datepicker({dateFormat:"mm/dd/yy"}),n(".kbs_select_chosen").chosen({inherit_select_classes:!0,placeholder_text_single:kbs_vars.one_option,placeholder_text_multiple:kbs_vars.one_or_more_option}),n(".kbs_select_chosen .chosen-search input").each(function(){var e=n(this).parent().parent().parent().prev("select.kbs_select_chosen").data("search-placeholder");n(this).attr("placeholder",e)}),n(".chosen-choices").on("click",function(){var e=n(this).parent().prev().data("search-placeholder");void 0===e&&(e=kbs_vars.type_to_search),n(this).children("li").children("input").attr("placeholder",e)}),n(document).on("click",".notice-kbs-dismiss .notice-dismiss",function(){var e=n(this).closest(".notice-kbs-dismiss").data("notice");n.ajax({type:"POST",dataType:"json",data:{notice:e,action:"kbs_dismiss_notice"},url:ajaxurl})});({init:function(){this.general(),this.uploads()},general:function(){var e=n(".kbs-color-picker");e.length&&e.wpColorPicker(),n(".logged_in_only").length&&n(".logged_in_only").is(":checked")&&n(".kbs_option_auto_add_user").hide(),n(".recaptcha_version").length&&"v2"!==n(".recaptcha_version").val()&&(n(".kbs_option_recaptcha_theme").hide(),n(".kbs_option_recaptcha_type").hide(),n(".kbs_option_recaptcha_size").hide()),n(document.body).on("change",".logged_in_only",function(){n(this).is(":checked")?n(".kbs_option_auto_add_user").fadeOut("fast"):n(".kbs_option_auto_add_user").fadeIn("fast")}),n(document.body).on("change",".recaptcha_version",function(){"v2"!==n(".recaptcha_version").val()?(n(".kbs_option_recaptcha_theme").fadeOut("fast"),n(".kbs_option_recaptcha_type").fadeOut("fast"),n(".kbs_option_recaptcha_size").fadeOut("fast")):(n(".kbs_option_recaptcha_theme").fadeIn("fast"),n(".kbs_option_recaptcha_type").fadeIn("fast"),n(".kbs_option_recaptcha_size").fadeIn("fast"))})},uploads:function(){var e,t;"undefined"==typeof wp||"1"!==kbs_vars.new_media_ui?0<(e=n(".kbs_settings_upload_button")).length&&(window.formfield="",n(document.body).on("click",e,function(e){e.preventDefault(),window.formfield=n(this).parent().prev(),window.tbframe_interval=setInterval(function(){jQuery("#TB_iframeContent").contents().find(".savesend .button").val(kbs_vars.use_this_file).end().find("#insert-gallery, .wp-post-thumbnail").hide()},2e3),tb_show(kbs_vars.add_new_ticket,"media-upload.php?TB_iframe=true")}),window.kbs_send_to_editor=window.send_to_editor,window.send_to_editor=function(e){window.formfield?(imgurl=n("a","<div>"+e+"</div>").attr("href"),window.formfield.val(imgurl),window.clearInterval(window.tbframe_interval),tb_remove()):window.kbs_send_to_editor(e),window.send_to_editor=window.kbs_send_to_editor,window.formfield="",window.imagefield=!1}):(window.formfield="",n(document.body).on("click",".kbs_settings_upload_button",function(e){e.preventDefault();e=n(this);window.formfield=n(this).parent().prev(),t||((t=wp.media.frames.file_frame=wp.media({frame:"post",state:"insert",title:e.data("uploader_title"),button:{text:e.data("uploader_button_text")},multiple:!1})).on("menu:render:default",function(e){e.unset("library-separator"),e.unset("gallery"),e.unset("featured-image"),e.unset("embed"),e.set({})}),t.on("insert",function(){t.state().get("selection").each(function(e){e=e.toJSON(),window.formfield.val(e.url)})})),t.open()}))}}).init();e={init:function(){this.notes(),this.options(),this.participants(),this.reply(),this.save()},save:function(){n(document.body).on("click","#save-post",function(){if("undefined"!=typeof tinyMCE&&tinyMCE.activeEditor&&!tinyMCE.activeEditor.isHidden()&&tinyMCE.triggerSave(),0<n("#kbs_ticket_reply").val().length)return confirm(kbs_vars.reply_has_data)}),n(document.body).on("change","#ticket_status",function(){"kbs_ticket"!==kbs_vars.post_type||"closed"!==n(this).val()||kbs_vars.disable_closure_email?(n("#kbs-closure-option").remove(),n("#kbs-closure-email").remove(),n('label[for="kbs-closure-email"]').remove()):(n(this).parent().append('<br id="kbs-closure-option">'),n(this).parent().append('<input type="checkbox" id="kbs-closure-email" name="kbs_closure_email" value="1" style="margin-top:0; margin-left: 4px;">'),n(this).parent().append('<label for="kbs-closure-email">'+kbs_vars.send_closure_email+"</label>"))})},options:function(){n(document.body).on("click",".toggle-flagged-status-option-section",function(e){e.preventDefault();e={ticket_id:kbs_vars.post_id,flagged:n(this).data("flag"),action:"kbs_set_ticket_flagged_status"};n.ajax({type:"POST",dataType:"json",data:e,url:ajaxurl,beforeSend:function(){n("#kbs-ticket-metabox-fields").addClass("kbs-mute"),n(".toggle-flagged-status-option-section").html(kbs_vars.please_wait)},success:function(e){!0===e.success&&("flagged"===e.data.flagged?(n("#kbs-ticket-flag-notice").show(),n(".toggle-flagged-status-option-section").html(kbs_vars.ticket_unflag),n(".toggle-flagged-status-option-section").data("flag","0")):(n("#kbs-ticket-flag-notice").hide(),n(".toggle-flagged-status-option-section").html(kbs_vars.ticket_flag),n(".toggle-flagged-status-option-section").data("flag","1")),kbs_load_ticket_notes(kbs_vars.post_id,e.data.note_id)),n("#kbs-ticket-metabox-fields").removeClass("kbs-mute")}}).fail(function(e){window.console&&window.console.log&&console.log(e)})}),n(document.body).on("click",".toggle-add-reply-option-section",function(e){e.preventDefault(),n("html, body").animate({scrollTop:n(".kbs-historic-reply-option-fields").offset().top},500)}),n(document.body).on("click",".toggle-view-participants-option-section",function(e){e.preventDefault();e=n(this).html()===kbs_vars.view_participants;e?n(this).html(kbs_vars.hide_participants):n(this).html(kbs_vars.view_participants),n("#kbs-ticket-participants-fields").slideToggle(),e&&n("html, body").animate({scrollTop:n("#kbs-ticket-participants-fields").offset().top},500)}),n(document.body).on("click",".toggle-view-submission-option-section",function(e){e.preventDefault();e=n(this).html()===kbs_vars.view_submission;e?n(this).html(kbs_vars.hide_submission):n(this).html(kbs_vars.view_submission),n("#kbs-ticket-formdata-fields").slideToggle(),e&&n("html, body").animate({scrollTop:n("#kbs-ticket-formdata-fields").offset().top},500)})},participants:function(){n(document.body).on("click","#kbs-add-participant",function(e){e.preventDefault(e);var t=n("#participant_id").val(),e=n("#participant_email").val();"-1"===t&&!e||(e={ticket_id:kbs_vars.post_id,participant:t,email:e,action:"kbs_add_participant"},n.ajax({type:"POST",dataType:"json",data:e,url:ajaxurl,beforeSend:function(){n("#kbs-ticket-participants-fields").addClass("kbs-mute"),n("#kbs-add-participant").attr("disabled",!0)},success:function(e){!0===e.success&&("-1"!==t&&n("#participant_id option:selected").remove(),n(".kbs-ticket-participants-list").html(e.data.list),n("#participant-count").text(e.data.count)),n("#participant_email").empty(),n("#participant_id").val("-1"),n("#participant_id").trigger("chosen:updated"),n("#kbs-add-participant").attr("disabled",!1),n("#kbs-ticket-participants-fields").removeClass("kbs-mute")}}).fail(function(e){window.console&&window.console.log&&console.log(e)}))}),n(document.body).on("click",".remove-participant",function(e){e.preventDefault(e);e={participant:n(this).data("participant"),ticket_id:kbs_vars.post_id,action:"kbs_remove_participant"};n.ajax({type:"POST",dataType:"json",data:e,url:ajaxurl,beforeSend:function(){n("#kbs-ticket-participants-fields").addClass("kbs-mute"),n("#kbs-add-participant").attr("disabled",!0)},success:function(e){!0===e.success&&(n(".kbs-ticket-participants-list").html(e.data.list),n("#participant-count").text(e.data.count)),n("#kbs-add-participant").attr("disabled",!1),n("#kbs-ticket-participants-fields").removeClass("kbs-mute")}}).fail(function(e){window.console&&window.console.log&&console.log(e)})})},reply:function(){"1"===kbs_vars.editing_ticket&&"1"===kbs_vars.reply_alerts&&(n(document).on("heartbeat-send",function(e,t){var s=n("#kbs-latest-reply").val();t.kbs_last_reply=s,t.kbs_ticket_id=kbs_vars.post_id}),n(document).on("heartbeat-tick",function(e,t){t.has_new_reply&&(n("#kbs-latest-reply").val(t.has_new_reply),confirm(kbs_vars.new_reply_notice))&&(n(".kbs-historic-reply-option-fields").empty(),kbs_load_ticket_replies(kbs_vars.post_id,0,1))})),n(document.body).on("click",".reply-delete",function(e){e.preventDefault(),confirm(kbs_vars.delete_ticket_warn)&&(window.location=n(this).attr("href"))}),n(document.body).on("click","#kbs-reply-close, #kbs-reply-update",function(e){e.preventDefault();var t=kbs_vars.post_id,s=kbs_vars.agent_set_status?n("#ticket_reply_status").val():kbs_vars.default_reply_status,i=n("#post").serialize();if("undefined"!=typeof tinyMCE&&tinyMCE.activeEditor&&!tinyMCE.activeEditor.isHidden()&&tinyMCE.triggerSave(),0===(a=n("#kbs_ticket_reply").val()).length)return window.alert(kbs_vars.no_ticket_reply_content),!1;if(("kbs-reply-close"===e.target.id||"closed"===s)&&!1===confirm(kbs_vars.ticket_confirm_close))return;var a={ticket_id:t,response:a,status:s,close_ticket:"kbs-reply-close"===e.target.id?1:0,form_data:i,action:"kbs_insert_ticket_reply"};n.ajax({type:"POST",dataType:"json",data:a,url:ajaxurl,beforeSend:function(){n(".kbs-reply").hide(),n("#kbs-new-reply-loader").html('<img src="'+kbs_vars.ajax_loader+'" />')},success:function(e){if(e.reply_id)return kbs_load_ticket_replies(t,e.reply_id,1),window.location.href=kbs_vars.admin_url+"?kbs-action=ticket_reply_added&ticket_id="+t,!0;window.alert(kbs_vars.reply_not_added),n("#kbs-new-reply-loader").html(""),n(".kbs-reply").show()}}).fail(function(e){window.console&&window.console.log&&console.log(e)})}),n(document.body).on("click","#kbs-replies-next-page",function(){var e=n("#kbs-replies-next-page").data("ticket-id"),t=n("#kbs-replies-next-page").data("load-page");n(".kbs-replies-load-more").remove(),kbs_load_ticket_replies(e,0,t)})},notes:function(){n(document.body).on("click","#kbs-add-note",function(){var e=n("#kbs_new_note").val(),t=kbs_vars.post_id;e.length<1?window.alert(kbs_vars.no_note_content):n.ajax({type:"POST",dataType:"json",data:{ticket_id:t,note_content:e,action:"kbs_insert_ticket_note"},url:ajaxurl,beforeSend:function(){n("#kbs-add-note").hide(),n("#kbs-new-note-loader").html('<img src="'+kbs_vars.ajax_loader+'" />')},success:function(e){e.note_id?(kbs_load_ticket_notes(t,e.note_id),n("#kbs_new_note").val("")):window.alert(kbs_vars.note_not_added),n("#kbs-new-note-loader").html(""),n("#kbs-add-note").show()}}).fail(function(e){window.console&&window.console.log&&console.log(e)})}),"1"===kbs_vars.editing_ticket&&setTimeout(function(){kbs_load_ticket_replies(kbs_vars.post_id,0,1),kbs_load_ticket_notes(kbs_vars.post_id,0)},200)}};n(document.body).on("click",".toggle-view-reply-option-section",function(e){e.preventDefault(),n(this).html()===kbs_vars.view_reply?n(this).html(kbs_vars.hide_reply):n(this).html(kbs_vars.view_reply),n(this).parents(".kbs-replies-row-header").siblings(".kbs-replies-content-wrap").slideToggle()}),n(document.body).on("click",".toggle-view-note-option-section",function(e){e.preventDefault(),n(this).html()===kbs_vars.view_note?n(this).html(kbs_vars.hide_note):n(this).html(kbs_vars.view_note),n(this).parents(".kbs-notes-row-header").siblings(".kbs-notes-content-wrap").slideToggle()}),e.init();({init:function(){this.forms(),this.move()},forms:function(){function e(e){"text"===e||"date_field"===e||"department"===e||"email"===e||"number"===e||"select"===e||"textarea"===e||"url"===e?n("#kbs_meta_field_placeholder_wrap").show():n("#kbs_meta_field_placeholder_wrap").hide(),"text"===e||"date_field"===e||"department"===e||"email"===e||"hidden"===e||"number"===e||"select"===e||"textarea"===e||"url"===e?n("#kbs_meta_field_hide_label_wrap").show():n("#kbs_meta_field_hide_label_wrap").hide(),"select"===e||"checkbox_list"===e||"radio"===e?n("#kbs_meta_field_select_options_wrap").show():n("#kbs_meta_field_select_options_wrap").hide(),"select"===e?n("#kbs_meta_field_select_multiple_wrap").show():n("#kbs_meta_field_select_multiple_wrap").hide(),"select"===e||"department"===e||"ticket_category_dropdown"===e?(n("#kbs_meta_field_select_blank_wrap").show(),n("#kbs_meta_field_select_searchable_wrap").show()):(n("#kbs_meta_field_select_blank_wrap").hide(),n("#kbs_meta_field_select_searchable_wrap").hide()),"checkbox"===e?n("#kbs_meta_field_option_selected_wrap").show():n("#kbs_meta_field_option_selected_wrap").hide(),"checkbox"===e||"file_upload"===e?n("#kbs_meta_field_required_wrap").hide():n("#kbs_meta_field_required_wrap").show(),"recaptcha"===e?(n("#kbs_meta_field_required_wrap").hide(),n("#kbs_meta_field_label_class_wrap").hide(),n("#kbs_meta_field_input_class_wrap").hide()):(n("#kbs_meta_field_required_wrap").show(),n("#kbs_meta_field_label_class_wrap").show(),n("#kbs_meta_field_input_class_wrap").show()),"text"===e||"email"===e||"hidden"===e||"url"===e||"textarea"===e||"rich_editor"===e||"department"===e?n("#kbs_meta_field_mapping_wrap").show():n("#kbs_meta_field_mapping_wrap").hide(),"hidden"===e?n("#kbs_meta_field_value_wrap").show():n("#kbs_meta_field_value_wrap").hide(),"post_title"===n("#kbs_field_mapping").val()?n("#kbs_meta_field_kb_search_wrap").show():n("#kbs_meta_field_kb_search_wrap").hide()}kbs_vars.editing_field_type&&e(kbs_vars.editing_field_type);var t=n(".kbs_field_type");n(document.body).on("change",t,function(){e(t.val())}),n(document.body).on("change",n("#kbs_field_mapping"),function(){"post_title"===n("#kbs_field_mapping").val()?n("#kbs_meta_field_kb_search_wrap").show():n("#kbs_meta_field_kb_search_wrap").hide()}),n(document.body).on("change",n("#kbs_field_select_chosen"),function(){n("#kbs_field_select_chosen").is(":checked")?n("#kbs_meta_field_select_search_text_wrap").show("fast"):n("#kbs_meta_field_select_search_text_wrap").hide("fast")}),n(document.body).on("click","#kbs-add-form-field",function(e){var t;return e.preventDefault(),n("#kbs_field_label").val().length<1?(window.alert(kbs_vars.field_label_missing),!1):"-1"===n("#kbs_field_type").val()?(window.alert(kbs_vars.field_type_missing),!1):(t=n("#form_return_url").val(),e={action:"kbs_add_form_field",blank:n("#kbs_field_select_blank").val(),chosen:n("#kbs_field_select_chosen").is(":checked")?n("#kbs_field_select_chosen").val():0,chosen_search:n("#kbs_field_select_chosen_search").val(),description:n("#kbs_field_description").val(),description_pos:n("input[name=kbs_field_description_pos]").filter(":checked").val(),form_data:n("#post").serialize(),form_id:kbs_vars.post_id,hide_label:n("#kbs_field_hide_label").is(":checked")?n("#kbs_field_hide_label").val():0,input_class:n("#kbs_field_input_class").val(),kb_search:n("#kbs_field_kb_search").is(":checked")?n("#kbs_field_kb_search").val():0,label:n("#kbs_field_label").val(),label_class:n("#kbs_field_label_class").val(),mapping:n("#kbs_field_mapping").val(),placeholder:n("#kbs_field_placeholder").val(),required:n("#kbs_field_required").is(":checked")?n("#kbs_field_required").val():0,selected:n("#kbs_field_option_selected").is(":checked")?n("#kbs_field_option_selected").val():0,select_multiple:n("#kbs_field_select_multiple").is(":checked")?n("#kbs_field_select_multiple").val():0,select_options:n("textarea#kbs_field_select_options").val(),type:n("#kbs_field_type").val(),value:n("#kbs_field_value").val()},void n.ajax({type:"POST",dataType:"json",data:e,url:ajaxurl,beforeSend:function(){n("#kbs-field-add").addClass("kbs-hidden"),n("#kbs-loading").removeClass("kbs-hidden")},success:function(e){return window.location.href=t+"&kbs-message="+e.message,!0}}).fail(function(e){n("#kbs-field-add").removeClass("kbs-hidden"),n("#kbs-loading").addClass("kbs-hidden"),window.console&&window.console.log&&console.log(e)}))}),n(document.body).on("click","#kbs-save-form-field",function(e){var t;return e.preventDefault(),n("#kbs_field_label").val().length<1?(window.alert(kbs_vars.field_label_missing),!1):"-1"===n("#kbs_field_type").val()?(window.alert(kbs_vars.field_type_missing),!1):(t=n("#form_return_url").val(),e={action:"kbs_save_form_field",blank:n("#kbs_field_select_blank").val(),chosen:n("#kbs_field_select_chosen").is(":checked")?n("#kbs_field_select_chosen").val():0,chosen_search:n("#kbs_field_select_chosen_search").val(),description:n("#kbs_field_description").val(),description_pos:n("input[name=kbs_field_description_pos]").filter(":checked").val(),field_id:n("#kbs_edit_field").val(),form_data:n("#post").serialize(),form_id:kbs_vars.post_id,hide_label:n("#kbs_field_hide_label").is(":checked")?n("#kbs_field_hide_label").val():0,input_class:n("#kbs_field_input_class").val(),kb_search:n("#kbs_field_kb_search").is(":checked")?n("#kbs_field_kb_search").val():0,label:n("#kbs_field_label").val(),label_class:n("#kbs_field_label_class").val(),mapping:n("#kbs_field_mapping").val(),placeholder:n("#kbs_field_placeholder").val(),required:n("#kbs_field_required").is(":checked")?n("#kbs_field_required").val():0,selected:n("#kbs_field_option_selected").is(":checked")?n("#kbs_field_option_selected").val():0,select_options:n("textarea#kbs_field_select_options").val(),select_multiple:n("#kbs_field_select_multiple").is(":checked")?n("#kbs_field_select_multiple").val():0,type:n("#kbs_field_type").val(),value:n("#kbs_field_value").val()},void n.ajax({type:"POST",dataType:"json",data:e,url:ajaxurl,beforeSend:function(){n("#kbs-field-save").addClass("kbs-hidden"),n("#kbs-loading").removeClass("kbs-hidden")},success:function(e){return window.location.href=t+"&kbs-message="+e.message,!0}}).fail(function(e){n("#kbs-field-save").removeClass("kbs-hidden"),n("#kbs-loading").addClass("kbs-hidden"),window.console&&window.console.log&&console.log(e)}))})},move:function(){n(".kbs_sortable_table tbody").sortable({handle:".kbs_draghandle",items:".kbs_sortable_row",opacity:.6,cursor:"move",axis:"y",update:function(){var e=n(this).sortable("serialize")+"&action=kbs_order_form_fields";n.post(ajaxurl,e,function(){})}})}}).init();var s={vars:{customer_wrap_editable:n(".kbs-customer-wrapper .editable"),customer_wrap_edit_item:n(".kbs-customer-wrapper .edit-item"),user_id:n('input[name="customerinfo[user_id]"]'),note:n("#customer-note")},init:function(){this.add_customer(),this.new_customer(),this.edit_customer(),this.cancel_edit(),this.add_email(),this.user_search(),this.remove_user(),this.add_note(),this.delete_checked()},add_customer:function(){n(document.body).on("click","#kbs-add-customer-save",function(e){e.preventDefault();var t=n(this),s=t.parent(),e=n("#customer-name").val(),i=n("#customer_company").val(),a=n("#customer-email").val(),o=n("add_customer_nonce").val();n.ajax({type:"POST",dataType:"json",data:{action:"kbs_add_customer",customer_name:e,customer_company:i,customer_email:a,_wpnonce:o},url:ajaxurl,beforeSend:function(){n(".notice-wrap").html(""),s.find(".spinner").css("visibility","visible"),t.attr("disabled",!0)},success:function(e){if(!e.error)return window.location.href=e.redirect,!0;t.attr("disabled",!1),n(".notice-wrap").html('<div class="notice notice-error"><p>'+e.message+"</p></div>"),s.find(".spinner").css("visibility","hidden")}}).fail(function(e){window.console&&window.console.log&&console.log(e)})})},new_customer:function(){n(document.body).on("click","#kbs-new-customer-save",function(e){e.preventDefault();var t=n(this),e=n("#kbs_name").val(),s=n("#kbs_email").val(),i=n("#kbs_company").val();""===e?alert(kbs_vars.customer_name_required):""===s?alert(kbs_vars.customer_email_required):n.ajax({type:"POST",dataType:"json",data:{action:"kbs_new_customer_for_ticket",customer_name:e,customer_email:s,customer_company:i},url:ajaxurl,beforeSend:function(){t.attr("disabled",!0),n("#add-customer").addClass("kbs-mute")},success:function(e){e.success?(n("#kbs_customer_id").append(e.data.option),n("#kbs_customer_id").val(e.data.id),n("#kbs_customer_id").trigger("chosen:updated"),t.attr("disabled",!1),n("#kbs_name").val(""),n("#kbs_email").val(""),n("#kbs_company").val("-1"),n("#kbs_company").trigger("chosen:updated"),tb_remove()):(t.attr("disabled",!1),e.data.message&&alert(e.data.message))}}).fail(function(e){window.console&&window.console.log&&console.log(e)})})},edit_customer:function(){n(document.body).on("click","#edit-customer",function(e){e.preventDefault(),s.vars.customer_wrap_editable.hide(),s.vars.customer_wrap_edit_item.fadeIn().css("display","block")})},cancel_edit:function(){n(document.body).on("click","#kbs-edit-customer-cancel",function(e){e.preventDefault(),s.vars.customer_wrap_edit_item.hide(),s.vars.customer_wrap_editable.show(),n(".kbs_user_search_results").html("")})},add_email:function(){n(document.body).on("click","#add-customer-email",function(e){e.preventDefault();var t=n(this),s=t.parent(),e=(s.parent().find(".notice-wrap").remove(),s.find(".spinner").css("visibility","visible"),t.attr("disabled",!0),s.find('input[name="customer-id"]').val()),i=s.find('input[name="additional-email"]').val(),a=s.find('input[name="make-additional-primary"]').is(":checked"),o=s.find('input[name="add_email_nonce"]').val();n.post(ajaxurl,{kbs_action:"customer-add-email",customer_id:e,email:i,primary:a,_wpnonce:o},function(e){!0===e.success?window.location.href=e.redirect:(t.attr("disabled",!1),s.after('<div class="notice-wrap"><div class="notice notice-error inline"><p>'+e.message+"</p></div></div>"),s.find(".spinner").css("visibility","hidden"))},"json")})},user_search:function(){n(document.body).on("click.kbsSelectUser",".kbs_user_search_results a",function(e){e.preventDefault();e=n(this).data("userid");s.vars.user_id.val(e)})},remove_user:function(){n(document.body).on("click","#disconnect-customer",function(e){e.preventDefault();e={kbs_action:"disconnect-userid",customer_id:n('input[name="customerinfo[id]"]').val(),_wpnonce:n("#edit-customer-info #_wpnonce").val()};n.post(ajaxurl,e,function(){window.location.href=window.location.href},"json")})},add_note:function(){n(document.body).on("click","#add-customer-note",function(e){e.preventDefault();var t,e={kbs_action:"add-customer-note",customer_id:n("#customer-id").val(),customer_note:s.vars.note.val(),add_customer_note_nonce:n("#add_customer_note_nonce").val()};e.customer_note?n.ajax({type:"POST",data:e,url:ajaxurl,success:function(e){n("#kbs-customer-notes").prepend(e),n(".kbs-no-customer-notes").hide(),s.vars.note.val("")}}).fail(function(e){window.console&&window.console.log&&console.log(e)}):(t=s.vars.note.css("border-color"),s.vars.note.css("border-color","red"),setTimeout(function(){s.vars.note.css("border-color",t)},500))})},delete_checked:function(){n("#kbs-customer-delete-confirm").change(function(){var e=n("#kbs-delete-customer");n(this).prop("checked")?e.attr("disabled",!1):e.attr("disabled",!0)})}};s.init(),{init:function(){this.contacts()},contacts:function(){n("#_kbs_company_customer").change(function(){var e;0!==n("#_kbs_company_customer").val()&&(e={action:"kbs_get_customer_data",company_id:kbs_vars.post_id,customer_id:n("#_kbs_company_customer").val()},n.ajax({type:"POST",dataType:"json",data:e,url:ajaxurl,success:function(e){n("#_kbs_company_contact").val(e.name),n("#_kbs_company_email").val(e.email),n("#_kbs_company_phone").val(e.phone),n("#_kbs_company_website").val(e.url)}}).fail(function(e){window.console&&window.console.log&&console.log(e)}))})}}.init(),{init:function(){this.submit(),this.dismiss_message()},submit:function(){var s=this;n(document.body).on("submit",".kbs-export-form",function(e){e.preventDefault();var t,e=n(this).find('input[type="submit"]');e.hasClass("button-disabled")||(t=n(this).serialize(),e.addClass("button-disabled"),n(this).find(".notice-wrap").remove(),n(this).append('<div class="notice-wrap"><span class="spinner is-active"></span><div class="kbs-progress"><div></div></div></div>'),s.process_step(1,t,s))})},process_step:function(e,i,a){n.ajax({type:"POST",url:ajaxurl,data:{form:i,action:"kbs_do_ajax_export",step:e},dataType:"json",success:function(e){var t,s;"done"===e.step||e.error||e.success?(t=(s=n(".kbs-export-form").find(".kbs-progress").parent().parent()).find(".notice-wrap"),s.find(".button-disabled").removeClass("button-disabled"),e.error?(s=e.message,t.html('<div class="updated error"><p>'+s+"</p></div>")):e.success?(s=e.message,t.html('<div id="kbs-batch-success" class="updated notice is-dismissible"><p>'+s+'<span class="notice-dismiss"></span></p></div>')):(t.remove(),window.location=e.url)):(n(".kbs-progress div").animate({width:e.percentage+"%"},50,function(){}),a.process_step(parseInt(e.step),i,a))}}).fail(function(e){window.console&&window.console.log&&console.log(e)})},dismiss_message:function(){n("body").on("click","#kbs-batch-success .notice-dismiss",function(){n("#kbs-batch-success").parent().slideUp("fast")})}}.init(),n(".kbs-ajax-user-search").keyup(function(){var e=n(this).val(),t="",e=(n(this).data("exclude")&&(t=n(this).data("exclude")),n(".kbs-ajax").show(),{action:"kbs_search_users",user_name:e,exclude:t});document.body.style.cursor="wait",n.ajax({type:"POST",data:e,dataType:"json",url:ajaxurl,success:function(e){n(".kbs-ajax").hide(),n(".kbs_user_search_results").removeClass("hidden"),n(".kbs_user_search_results span").html(""),n(e.results).appendTo(".kbs_user_search_results span"),document.body.style.cursor="default"}})}),n(document.body).on("click.kbsSelectUser",".kbs_user_search_results span a",function(e){e.preventDefault();e=n(this).data("login");n(".kbs-ajax-user-search").val(e),n(".kbs_user_search_results").addClass("hidden"),n(".kbs_user_search_results span").html("")}),n(document.body).on("click.kbsCancelUserSearch",".kbs_user_search_results a.kbs-ajax-user-cancel",function(e){e.preventDefault(),n(".kbs-ajax-user-search").val(""),n(".kbs_user_search_results").addClass("hidden"),n(".kbs_user_search_results span").html("")}),n("#kbs_dashboard_tickets").length&&n.ajax({type:"GET",data:{action:"kbs_load_dashboard_widget"},url:ajaxurl,success:function(e){n("#kbs_dashboard_tickets .inside").html(e)}}),n(document).on("keydown",".customer-note-input",function(e){13===e.keyCode&&(e.metaKey||e.ctrlKey)&&n("#add-customer-note").click()})}),KBSShowNotice={warn:function(e){void 0===e&&(e="ticket");e=kbs_vars.delete_ticket_warn||"";return!!confirm(e)},note:function(e){alert(e)}};